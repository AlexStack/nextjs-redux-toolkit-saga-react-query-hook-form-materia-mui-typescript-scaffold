{"type_of":"article","id":1245058,"title":"Killing mutants to improve your tests","description":"At my current client we're working on having a frontend architecture for writing SPAs in JavaScript...","readable_publish_date":"Nov 7","slug":"killing-mutants-to-improve-your-tests-5bep","path":"/trikitrok/killing-mutants-to-improve-your-tests-5bep","url":"https://dev.to/trikitrok/killing-mutants-to-improve-your-tests-5bep","comments_count":1,"public_reactions_count":8,"collection_id":null,"published_timestamp":"2022-11-07T10:10:24Z","positive_reactions_count":8,"cover_image":"https://res.cloudinary.com/practicaldev/image/fetch/s--cCX1BQMv--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/lrfhrhgefivjc26e5reo.jpg","social_image":"https://res.cloudinary.com/practicaldev/image/fetch/s--kVsdtNbL--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/lrfhrhgefivjc26e5reo.jpg","canonical_url":"https://codesai.com/posts/2019/05/killing-mutants-to-improve-tests","created_at":"2022-11-05T23:18:39Z","edited_at":null,"crossposted_at":null,"published_at":"2022-11-07T10:10:24Z","last_comment_at":"2022-11-07T13:56:37Z","reading_time_minutes":3,"tag_list":"mutationtesting, testing, javascript, stryker","tags":["mutationtesting","testing","javascript","stryker"],"body_html":"<p>At my current client we're working on having a frontend architecture for writing SPAs in JavaScript similar to <a href=\"https://github.com/Day8/re-frame\">re-frame</a>'s one: an event-driven bus with effects and coeffects for state management<a href=\"#nota1\"><sup>[1]</sup></a> (commands) and subscriptions using <a href=\"https://github.com/reduxjs/reselect\">reselect</a>'s selectors (queries).  </p>\n\n<p>One of the pieces we have developed to achieved that goal is <a href=\"https://github.com/trovit/reffects/tree/master/packages/reffects-store\">reffects-store</a>. Using this store, <a href=\"https://reactjs.org/\">React</a> components can be subscribed to given <a href=\"https://github.com/reduxjs/reselect\">reselect</a>'s selectors, so that they only render when the values in the application state tracked by the selectors change.</p>\n\n<p>After we finished writing the code for the store, we decided to use <a href=\"https://en.wikipedia.org/wiki/Mutation_testing\">mutation testing</a> to evaluate the quality of our tests. <em>Mutation testing</em> is a technique in which, you introduce bugs, (<em>mutations</em>), into your production code, and then run your tests for each mutation. If your tests fail, it's ok, the mutation was \"killed\", that means that they were able to defend you against the regression caused by the mutation. If they don't, it means your tests are not defending you against that regression. The higher the percentage of mutations killed, the more effective your tests are.</p>\n\n<p>There are tools that do this automatically, <a href=\"https://stryker-mutator.io/\">stryker</a><a href=\"#nota2\"><sup>[2]</sup></a> is one of them. When you run <em>stryker</em>, it will create many mutant versions of your production code, and run your tests for each mutant (that's how mutations are called in <em>stryker</em>'s' documentation) version of the code. If your tests fail then the mutant is killed. If your tests passed, the mutant survived. Let's have a look at the the result of runnning <em>stryker</em> against <a href=\"https://github.com/trovit/reffects/tree/master/packages/reffects-store\">reffects-store</a>'s code:</p>\n\n\n<div class=\"ltag_gist-liquid-tag\">\n  <script id=\"gist-ltag\" src=\"https://gist.github.com/trikitrok/0fe2dee6b69016d784849f61d3cae80f.js\"></script>\n</div>\n\n\n<p>Notice how <em>stryker</em> shows the details of every mutation that survived our tests, and look at the summary the it produces at the end of the process.</p>\n\n<p>All the surviving mutants were produced by mutations to the <code>store.js</code> file. Having a closer look to the mutations in <em>stryker</em>'s output we found that the functions with mutant code were <code>unsubscribeAllListeners</code> and <code>unsubscribeListener</code>.<br>\nAfter a quick check of their tests, it was esay to find out why <code>unsubscribeAllListeners</code> was having surviving mutants. Since it was a function we used only in tests for cleaning the state after each test case was run, we had forgotten to test it. </p>\n\n<p>However, finding out why <code>unsubscribeListener</code> mutants were surviving took us a bit more time and thinking.<br>\nLet's have a look at the tests that were exercising the code used to subscribe and unsubscribe listeners of state changes:</p>\n\n\n<div class=\"ltag_gist-liquid-tag\">\n  <script id=\"gist-ltag\" src=\"https://gist.github.com/trikitrok/62a6892d957ffc21d9f9430fd4b2f359.js\"></script>\n</div>\n\n\n<p>If we examine the mutations and the tests, we can see that the tests for <code>unsubscribeListener</code> are not good enough. They are throwing an exception from the subscribed function we unsubscribe, so that if the <code>unsubscribeListener</code> function doesn't work and that function is called the test fails. Unfortunately, the test passes also if that function is never called for any reason. In fact, most of the surviving mutants that <em>stryker</em> found above have are variations on that idea.</p>\n\n<p>A better way to test <code>unsubscribeListener</code> is using spies to verify that subscribed functions are called and unsubscribed functions are not (this version of the tests includes also a test for <code>unsubscribeAllListeners</code>):</p>\n\n\n<div class=\"ltag_gist-liquid-tag\">\n  <script id=\"gist-ltag\" src=\"https://gist.github.com/trikitrok/4e64ce106b74e0f3b9e304933a32fc35.js\"></script>\n</div>\n\n\n<p>After this change, when we run <em>stryker</em> we got the following output:</p>\n\n\n<div class=\"ltag_gist-liquid-tag\">\n  <script id=\"gist-ltag\" src=\"https://gist.github.com/trikitrok/93b40e7f4318159f2c3022b8e0119811.js\"></script>\n</div>\n\n\n<p>No mutants survived!! This means this new version of the tests is more reliable and will protect us better from regressions than the initial version. </p>\n\n<p>Mutation testing is a great tool to know if you can trust your tests. This is event more true when working with legacy code.</p>\n\n<p><strong>Acknowledgements.</strong></p>\n\n<p>Many thanks to <a href=\"https://twitter.com/MrMSanchez\">Mario Sánchez</a> and <a href=\"https://twitter.com/alexhoma_\">Alex Casajuana Martín</a> for all the great time coding together, and thanks to Porapak Apichodilok for the <a href=\"https://www.pexels.com/photo/boy-child-clouds-kid-346796/\">photo used in this post</a> and to <a href=\"https://www.pexels.com/\">Pexels</a>.</p>\n\n<p><strong>Footnotes</strong>:</p>\n\n<p><a name=\"nota1\"></a> [1] See also <a href=\"https://github.com/trovit/reffects\">reffects</a> which is the synchronous event bus with effects and coeffects we wrote to manage the application state.</p>\n\n<p><a name=\"nota2\"></a> [2] The name of this tool comes from a fictional Marvel comics supervillain <a href=\"https://en.wikipedia.org/wiki/William_Stryker\">Willian Stryker</a> who was obsessed with the eradication of all mutants.</p>\n\n","body_markdown":"---\ntitle: \"Killing mutants to improve your tests\"\npublished: true\ndescription: \ntags: \n- mutationtesting \n- testing\n- javascript\n- stryker\ncanonical_url: https://codesai.com/posts/2019/05/killing-mutants-to-improve-tests\ncover_image: https://dev-to-uploads.s3.amazonaws.com/uploads/articles/lrfhrhgefivjc26e5reo.jpg\n# Use a ratio of 100:42 for best results.\n# published_at: 2022-11-05 23:13 +0000\n---\n\nAt my current client we're working on having a frontend architecture for writing SPAs in JavaScript similar to [re-frame](https://github.com/Day8/re-frame)'s one: an event-driven bus with effects and coeffects for state management<a href=\"#nota1\"><sup>[1]</sup></a> (commands) and subscriptions using [reselect](https://github.com/reduxjs/reselect)'s selectors (queries).  \n\nOne of the pieces we have developed to achieved that goal is [reffects-store](https://github.com/trovit/reffects/tree/master/packages/reffects-store). Using this store, [React](https://reactjs.org/) components can be subscribed to given [reselect](https://github.com/reduxjs/reselect)'s selectors, so that they only render when the values in the application state tracked by the selectors change.\n\nAfter we finished writing the code for the store, we decided to use [mutation testing](https://en.wikipedia.org/wiki/Mutation_testing) to evaluate the quality of our tests. *Mutation testing* is a technique in which, you introduce bugs, (*mutations*), into your production code, and then run your tests for each mutation. If your tests fail, it's ok, the mutation was \"killed\", that means that they were able to defend you against the regression caused by the mutation. If they don't, it means your tests are not defending you against that regression. The higher the percentage of mutations killed, the more effective your tests are.\n\nThere are tools that do this automatically, [stryker](https://stryker-mutator.io/)<a href=\"#nota2\"><sup>[2]</sup></a> is one of them. When you run *stryker*, it will create many mutant versions of your production code, and run your tests for each mutant (that's how mutations are called in *stryker*'s' documentation) version of the code. If your tests fail then the mutant is killed. If your tests passed, the mutant survived. Let's have a look at the the result of runnning *stryker* against [reffects-store](https://github.com/trovit/reffects/tree/master/packages/reffects-store)'s code:\n\n{% gist https://gist.github.com/trikitrok/0fe2dee6b69016d784849f61d3cae80f %}\n\nNotice how *stryker* shows the details of every mutation that survived our tests, and look at the summary the it produces at the end of the process.\n\nAll the surviving mutants were produced by mutations to the `store.js` file. Having a closer look to the mutations in *stryker*'s output we found that the functions with mutant code were `unsubscribeAllListeners` and `unsubscribeListener`.\nAfter a quick check of their tests, it was esay to find out why `unsubscribeAllListeners` was having surviving mutants. Since it was a function we used only in tests for cleaning the state after each test case was run, we had forgotten to test it. \n\nHowever, finding out why `unsubscribeListener` mutants were surviving took us a bit more time and thinking.\nLet's have a look at the tests that were exercising the code used to subscribe and unsubscribe listeners of state changes:\n\n{% gist https://gist.github.com/trikitrok/62a6892d957ffc21d9f9430fd4b2f359 %}\n\nIf we examine the mutations and the tests, we can see that the tests for `unsubscribeListener` are not good enough. They are throwing an exception from the subscribed function we unsubscribe, so that if the `unsubscribeListener` function doesn't work and that function is called the test fails. Unfortunately, the test passes also if that function is never called for any reason. In fact, most of the surviving mutants that *stryker* found above have are variations on that idea.\n\nA better way to test `unsubscribeListener` is using spies to verify that subscribed functions are called and unsubscribed functions are not (this version of the tests includes also a test for `unsubscribeAllListeners`):\n\n{% gist https://gist.github.com/trikitrok/4e64ce106b74e0f3b9e304933a32fc35 %}\n\nAfter this change, when we run *stryker* we got the following output:\n\n{% gist https://gist.github.com/trikitrok/93b40e7f4318159f2c3022b8e0119811 %}\n\nNo mutants survived!! This means this new version of the tests is more reliable and will protect us better from regressions than the initial version. \n\nMutation testing is a great tool to know if you can trust your tests. This is event more true when working with legacy code.\n\n**Acknowledgements.**\n\nMany thanks to <a href=\"https://twitter.com/MrMSanchez\">Mario Sánchez</a> and <a href=\"https://twitter.com/alexhoma_\">Alex Casajuana Martín</a> for all the great time coding together, and thanks to Porapak Apichodilok for the [photo used in this post](https://www.pexels.com/photo/boy-child-clouds-kid-346796/) and to [Pexels](https://www.pexels.com/).\n\n**Footnotes**:\n\n<div class=\"foot-note\">\n  <a name=\"nota1\"></a> [1] See also <a href=\"https://github.com/trovit/reffects\">reffects</a> which is the synchronous event bus with effects and coeffects we wrote to manage the application state.\n</div>\n<div class=\"foot-note\">\n  <a name=\"nota2\"></a> [2] The name of this tool comes from a fictional Marvel comics supervillain <a href=\"https://en.wikipedia.org/wiki/William_Stryker\">Willian Stryker</a> who was obsessed with the eradication of all mutants.\n</div>\n","user":{"name":"Manuel Rivero","username":"trikitrok","twitter_username":null,"github_username":"trikitrok","user_id":93817,"website_url":"http://garajeando.blogspot.com/","profile_image":"https://res.cloudinary.com/practicaldev/image/fetch/s--57DoTHh_--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/93817/5d302d2e-d2f4-4c8d-b61f-1b0a39b063ff.jpeg","profile_image_90":"https://res.cloudinary.com/practicaldev/image/fetch/s--jg2dfDZn--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/93817/5d302d2e-d2f4-4c8d-b61f-1b0a39b063ff.jpeg"}}