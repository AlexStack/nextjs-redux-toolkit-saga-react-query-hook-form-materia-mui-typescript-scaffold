{"type_of":"article","id":1246157,"title":"Publier un package avec esbuild","description":"Introduction   Personnellement j'apprécie pouvoir partager mon code avec la communauté open...","readable_publish_date":"Nov 7","slug":"publier-un-package-avec-esbuild-3mc0","path":"/simonboisset/publier-un-package-avec-esbuild-3mc0","url":"https://dev.to/simonboisset/publier-un-package-avec-esbuild-3mc0","comments_count":0,"public_reactions_count":0,"collection_id":20012,"published_timestamp":"2022-11-07T07:20:33Z","positive_reactions_count":0,"cover_image":null,"social_image":"https://dev.to/social_previews/article/1246157.png","canonical_url":"https://dev.to/simonboisset/publier-un-package-avec-esbuild-3mc0","created_at":"2022-11-07T06:22:20Z","edited_at":"2022-11-07T07:25:27Z","crossposted_at":null,"published_at":"2022-11-07T07:20:33Z","last_comment_at":"2022-11-07T07:20:33Z","reading_time_minutes":3,"tag_list":"npm, esbuild, javascript, typescript","tags":["npm","esbuild","javascript","typescript"],"body_html":"<h2>\n  <a name=\"introduction\" href=\"#introduction\">\n  </a>\n  Introduction\n</h2>\n\n<p>Personnellement j'apprécie pouvoir partager mon code avec la communauté open source. Publier des packages npm pour cela est une des principales options. Mais pour s'assurer que son code soit exécutable sur n'importe quel environnement il faut certains prérequis.</p>\n\n<p>La règle numéro 1 à suivre est de supporter le common js.</p>\n\n<p>Pendant longtemps il fallait utiliser un bundler comme rollup, webpack ou babel.</p>\n\n<p>Mais aujourd'hui une nouvelle génération de bundler arrivent, plus performants et plus faciles à paramétrer. esbuild est l'un d'eux et nous allons l'utiliser pour publier notre premier module npm.</p>\n\n<h2>\n  <a name=\"initialisation\" href=\"#initialisation\">\n  </a>\n  Initialisation\n</h2>\n\n<p>Créez un projet et initialisez le.<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>yarn init\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Votre fichier package.json doit être comme ceci :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"name\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"my-react-library\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"1.0.0\"</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Maintenant, installons nos librairies.</p>\n\n<h2>\n  <a name=\"les-dev-dependencies\" href=\"#les-dev-dependencies\">\n  </a>\n  Les dev dependencies\n</h2>\n\n\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>yarn add <span class=\"nt\">-D</span> react react-dom typescript @types/react @types/react-dom\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote>\n<p>Pensez à ajouter react comme peer dependency si vous souhaitez écrire une librairie react avec des hooks ou des composants.<br>\n</p>\n</blockquote>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight json\"><code><span class=\"nl\">\"peerDependencies\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n   </span><span class=\"nl\">\"react\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"&gt;=16\"</span><span class=\"w\">\n </span><span class=\"p\">}</span><span class=\"err\">,</span><span class=\"w\">\n</span></code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name=\"typescript-config\" href=\"#typescript-config\">\n  </a>\n  Typescript config\n</h2>\n\n<p>Ajoutez le fichier <code>tsconfig.json</code>.<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight json\"><code><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"include\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"src\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"nl\">\"compilerOptions\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"module\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"esnext\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"target\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"esnext\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"lib\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"dom\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dom.iterable\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"esnext\"</span><span class=\"p\">],</span><span class=\"w\">\n    </span><span class=\"nl\">\"declaration\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"strict\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"moduleResolution\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"node\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"jsx\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"react\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"skipLibCheck\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"esModuleInterop\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"emitDeclarationOnly\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"outDir\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"dist\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"nl\">\"rootDir\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"src\"</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote>\n<p>On n'utilise pas le compilateur typescript car nous allons utiliser esbuild pour cela. C'est pour ça que <code>emitDeclarationOnly</code> est à true </p>\n</blockquote>\n\n<h2>\n  <a name=\"notre-module\" href=\"#notre-module\">\n  </a>\n  Notre module\n</h2>\n\n<p>Maintenant, on peut écrire le module de nos envies. Voici un exemple basique.</p>\n\n<p>Créez un dossier <code>src</code> puis un fichier <code>index.tsx</code>.<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight tsx\"><code><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">MyComponent</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">return</span> <span class=\"p\">&lt;</span><span class=\"nt\">div</span><span class=\"p\">&gt;</span>Hello word<span class=\"p\">&lt;/</span><span class=\"nt\">div</span><span class=\"p\">&gt;</span>\n<span class=\"p\">}</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name=\"build-de-notre-librairie\" href=\"#build-de-notre-librairie\">\n  </a>\n  Build de notre librairie\n</h2>\n\n<p>On souhaite maintenant builder notre package en CJS avant de le publier.</p>\n\n<h3>\n  <a name=\"configuration-esbuild\" href=\"#configuration-esbuild\">\n  </a>\n  Configuration esbuild\n</h3>\n\n<p>Ajoutez esbuild :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>yarn add <span class=\"nt\">-D</span> esbuild esbuild-node-externals\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Créez un script esbuild dans un fichier <code>esbuild.js</code> :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight javascript\"><code><span class=\"kd\">const</span> <span class=\"nx\">esbuild</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">esbuild</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"p\">{</span> <span class=\"nx\">nodeExternalsPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">esbuild-node-externals</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"nx\">esbuild</span>\n  <span class=\"p\">.</span><span class=\"nx\">build</span><span class=\"p\">({</span>\n    <span class=\"na\">entryPoints</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"dl\">'</span><span class=\"s1\">./src/index.ts</span><span class=\"dl\">'</span><span class=\"p\">],</span>\n    <span class=\"na\">outfile</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">dist/index.js</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n    <span class=\"na\">bundle</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"na\">minify</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"na\">treeShaking</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"na\">platform</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">node</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n    <span class=\"na\">format</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">cjs</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n    <span class=\"na\">target</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">node14</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n    <span class=\"na\">plugins</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">nodeExternalsPlugin</span><span class=\"p\">()],</span>\n  <span class=\"p\">})</span>\n  <span class=\"p\">.</span><span class=\"k\">catch</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">));</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name=\"ajoutez-la-commande-de-build\" href=\"#ajoutez-la-commande-de-build\">\n  </a>\n  Ajoutez la commande de build\n</h3>\n\n<p>Enfin, ajoutez le script dans le fichier package.json :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight json\"><code><span class=\"w\"> </span><span class=\"nl\">\"scripts\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"nl\">\"build\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"rm -rf dist &amp;&amp; node esbuild.js &amp;&amp; tsc\"</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"err\">,</span><span class=\"w\">\n</span></code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Maintenant, vous pouvez lancer le script :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>yarn build\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name=\"npm-publish\" href=\"#npm-publish\">\n  </a>\n  Npm publish\n</h2>\n\n<blockquote>\n<p>Avant de publier sur npm vous devez vous <a href=\"https://docs.npmjs.com/creating-a-new-npm-user-account\">authentifier</a></p>\n</blockquote>\n\n<p>Ajoutez ces lignes à votre package.json :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight json\"><code><span class=\"w\"> </span><span class=\"nl\">\"main\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"dist/index.js\"</span><span class=\"err\">,</span><span class=\"w\">\n  </span><span class=\"nl\">\"files\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n    </span><span class=\"s2\">\"dist\"</span><span class=\"w\">\n  </span><span class=\"p\">]</span><span class=\"err\">,</span><span class=\"w\">\n</span></code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Puis publiez votre package :<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight shell\"><code>npm publish\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Félicitations, venez de publier votre propre librairie Typescript.</p>\n\n<h2>\n  <a name=\"automatiser-la-publication-avec-les-github-actions\" href=\"#automatiser-la-publication-avec-les-github-actions\">\n  </a>\n  Automatiser la publication avec les Github actions\n</h2>\n\n<p>Finalement on veut juste publier une nouvelle version quand on déclenche une action sur Github. On va donc ajouter un fichier<br>\n<code>.github/workflows/publish.yml</code>:<br>\n</p>\n\n<div class=\"highlight js-code-highlight\">\n<pre class=\"highlight yaml\"><code><span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Publish</span>\n<span class=\"na\">on</span><span class=\"pi\">:</span>\n  <span class=\"na\">workflow_dispatch</span><span class=\"pi\">:</span>\n    <span class=\"na\">inputs</span><span class=\"pi\">:</span>\n      <span class=\"na\">release</span><span class=\"pi\">:</span>\n        <span class=\"na\">description</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">major</span><span class=\"nv\"> </span><span class=\"s\">|</span><span class=\"nv\"> </span><span class=\"s\">minor</span><span class=\"nv\"> </span><span class=\"s\">|</span><span class=\"nv\"> </span><span class=\"s\">patch'</span>\n        <span class=\"na\">required</span><span class=\"pi\">:</span> <span class=\"no\">true</span>\n        <span class=\"na\">default</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">patch'</span>\n        <span class=\"na\">type</span><span class=\"pi\">:</span> <span class=\"s\">choice</span>\n        <span class=\"na\">options</span><span class=\"pi\">:</span>\n          <span class=\"pi\">-</span> <span class=\"s\">major</span>\n          <span class=\"pi\">-</span> <span class=\"s\">minor</span>\n          <span class=\"pi\">-</span> <span class=\"s\">patch</span>\n<span class=\"na\">jobs</span><span class=\"pi\">:</span>\n  <span class=\"na\">publish-new-version</span><span class=\"pi\">:</span>\n    <span class=\"na\">runs-on</span><span class=\"pi\">:</span> <span class=\"s\">ubuntu-latest</span>\n    <span class=\"na\">steps</span><span class=\"pi\">:</span>\n      <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Checkout main</span>\n        <span class=\"na\">uses</span><span class=\"pi\">:</span> <span class=\"s\">actions/checkout@v2</span>\n      <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Use Node</span>\n        <span class=\"na\">uses</span><span class=\"pi\">:</span> <span class=\"s\">actions/setup-node@v1</span>\n        <span class=\"na\">with</span><span class=\"pi\">:</span>\n          <span class=\"na\">node-version</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">14'</span>\n          <span class=\"na\">registry-url</span><span class=\"pi\">:</span> <span class=\"s\">https://registry.npmjs.org/</span>\n      <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Install dependencies</span>\n        <span class=\"na\">run</span><span class=\"pi\">:</span> <span class=\"s\">yarn</span>\n      <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Build</span>\n        <span class=\"na\">run</span><span class=\"pi\">:</span> <span class=\"s\">yarn build</span>\n      <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Publish New Version</span>\n        <span class=\"na\">env</span><span class=\"pi\">:</span>\n          <span class=\"na\">NODE_AUTH_TOKEN</span><span class=\"pi\">:</span> <span class=\"s\">${{secrets.NPM_TOKEN}}</span>\n        <span class=\"na\">run</span><span class=\"pi\">:</span> <span class=\"pi\">|</span>\n          <span class=\"s\">git config --local user.email \"myEmail\"</span>\n          <span class=\"s\">git config --local user.name \"myUsername\"</span>\n          <span class=\"s\">yarn version --new-version ${{github.event.inputs.release}} --no-git-tag-version</span>\n          <span class=\"s\">yarn publish --access public</span>\n          <span class=\"s\">PACKAGE_VERSION=$(node -p \"require('./package.json').version\")</span>\n          <span class=\"s\">git commit -a -m \"v${PACKAGE_VERSION}\"</span>\n          <span class=\"s\">git push</span>\n</code></pre>\n<div class=\"highlight__panel js-actions-panel\">\n<div class=\"highlight__panel-action js-fullscreen-code-action\">\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"><title>Enter fullscreen mode</title>\n    <path d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"></path>\n</svg>\n\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"><title>Exit fullscreen mode</title>\n    <path d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name=\"ajoutez-votre-npm-token\" href=\"#ajoutez-votre-npm-token\">\n  </a>\n  Ajoutez votre npm token\n</h3>\n\n<p>Pour faire fonctionner les actions on doit enregistrer un secret NPM_TOKEN.</p>\n\n<p>Il faut générer un access token sur npm :</p>\n\n<p><a href=\"https://res.cloudinary.com/practicaldev/image/fetch/s--rMzWrFvP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9icyha61tyima21mtzf5.png\" class=\"article-body-image-wrapper\"><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--rMzWrFvP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9icyha61tyima21mtzf5.png\" alt=\"Npm access token\" loading=\"lazy\" width=\"880\" height=\"147\"></a></p>\n\n<p>Copiez le token dans les secrets Github :<br>\n<a href=\"https://res.cloudinary.com/practicaldev/image/fetch/s--KOcp6YPF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xy2xsmbx8v7e6ka5plex.png\" class=\"article-body-image-wrapper\"><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--KOcp6YPF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xy2xsmbx8v7e6ka5plex.png\" alt=\"Github action secret\" loading=\"lazy\" width=\"880\" height=\"470\"></a></p>\n\n<p>Maintenant tout fonctionne, votre publication se fera toute seule.</p>\n\n<p><a href=\"https://res.cloudinary.com/practicaldev/image/fetch/s--v-OwBRds--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oe3ocya9kr94ft0ukbmv.png\" class=\"article-body-image-wrapper\"><img src=\"https://res.cloudinary.com/practicaldev/image/fetch/s--v-OwBRds--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oe3ocya9kr94ft0ukbmv.png\" alt=\"Trigger github action\" loading=\"lazy\" width=\"880\" height=\"410\"></a></p>\n\n","body_markdown":"## Introduction\n\nPersonnellement j'apprécie pouvoir partager mon code avec la communauté open source. Publier des packages npm pour cela est une des principales options. Mais pour s'assurer que son code soit exécutable sur n'importe quel environnement il faut certains prérequis.\n\nLa règle numéro 1 à suivre est de supporter le common js.\n\nPendant longtemps il fallait utiliser un bundler comme rollup, webpack ou babel.\n\nMais aujourd'hui une nouvelle génération de bundler arrivent, plus performants et plus faciles à paramétrer. esbuild est l'un d'eux et nous allons l'utiliser pour publier notre premier module npm.\n\n## Initialisation\n\nCréez un projet et initialisez le.\n\n```bash\nyarn init\n```\n\nVotre fichier package.json doit être comme ceci :\n```json\n{\n  \"name\": \"my-react-library\",\n  \"version\": \"1.0.0\"\n}\n```\n\nMaintenant, installons nos librairies.\n\n## Les dev dependencies\n\n```bash\nyarn add -D react react-dom typescript @types/react @types/react-dom\n```\n\n> Pensez à ajouter react comme peer dependency si vous souhaitez écrire une librairie react avec des hooks ou des composants.\n\n```json\n\"peerDependencies\": {\n   \"react\": \">=16\"\n },\n```\n\n## Typescript config\n\nAjoutez le fichier `tsconfig.json`.\n\n```json\n{\n  \"include\": [\"src\"],\n  \"compilerOptions\": {\n    \"module\": \"esnext\",\n    \"target\": \"esnext\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"declaration\": true,\n    \"strict\": true,\n    \"moduleResolution\": \"node\",\n    \"jsx\": \"react\",\n    \"skipLibCheck\": true,\n    \"esModuleInterop\": true,\n    \"emitDeclarationOnly\": true,\n    \"outDir\": \"dist\",\n    \"rootDir\": \"src\"\n  }\n}\n```\n\n> On n'utilise pas le compilateur typescript car nous allons utiliser esbuild pour cela. C'est pour ça que `emitDeclarationOnly` est à true \n\n## Notre module\n\nMaintenant, on peut écrire le module de nos envies. Voici un exemple basique.\n\nCréez un dossier `src` puis un fichier `index.tsx`.\n\n```tsx\nexport const MyComponent = () => {\n  return <div>Hello word</div>\n}\n``` \n\n## Build de notre librairie\n\nOn souhaite maintenant builder notre package en CJS avant de le publier.\n\n### Configuration esbuild\n\nAjoutez esbuild :\n\n```bash\nyarn add -D esbuild esbuild-node-externals\n```\n\nCréez un script esbuild dans un fichier `esbuild.js` :\n\n```js\nconst esbuild = require('esbuild');\nconst { nodeExternalsPlugin } = require('esbuild-node-externals');\nesbuild\n  .build({\n    entryPoints: ['./src/index.ts'],\n    outfile: 'dist/index.js',\n    bundle: true,\n    minify: true,\n    treeShaking: true,\n    platform: 'node',\n    format: 'cjs',\n    target: 'node14',\n    plugins: [nodeExternalsPlugin()],\n  })\n  .catch(() => process.exit(1));\n```\n\n### Ajoutez la commande de build\n\nEnfin, ajoutez le script dans le fichier package.json : \n\n```json\n \"scripts\": {\n    \"build\": \"rm -rf dist && node esbuild.js && tsc\"\n  },\n```\n\nMaintenant, vous pouvez lancer le script : \n\n```bash\nyarn build\n```\n\n## Npm publish\n\n> Avant de publier sur npm vous devez vous [authentifier](https://docs.npmjs.com/creating-a-new-npm-user-account)\n\nAjoutez ces lignes à votre package.json :\n\n```json\n \"main\": \"dist/index.js\",\n  \"files\": [\n    \"dist\"\n  ],\n```\n\nPuis publiez votre package :\n\n```bash\nnpm publish\n```\n\nFélicitations, venez de publier votre propre librairie Typescript.\n\n## Automatiser la publication avec les Github actions\n\nFinalement on veut juste publier une nouvelle version quand on déclenche une action sur Github. On va donc ajouter un fichier\n`.github/workflows/publish.yml`:\n\n```yml\nname: Publish\non:\n  workflow_dispatch:\n    inputs:\n      release:\n        description: 'major | minor | patch'\n        required: true\n        default: 'patch'\n        type: choice\n        options:\n          - major\n          - minor\n          - patch\njobs:\n  publish-new-version:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout main\n        uses: actions/checkout@v2\n      - name: Use Node\n        uses: actions/setup-node@v1\n        with:\n          node-version: '14'\n          registry-url: https://registry.npmjs.org/\n      - name: Install dependencies\n        run: yarn\n      - name: Build\n        run: yarn build\n      - name: Publish New Version\n        env:\n          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}\n        run: |\n          git config --local user.email \"myEmail\"\n          git config --local user.name \"myUsername\"\n          yarn version --new-version ${{github.event.inputs.release}} --no-git-tag-version\n          yarn publish --access public\n          PACKAGE_VERSION=$(node -p \"require('./package.json').version\")\n          git commit -a -m \"v${PACKAGE_VERSION}\"\n          git push\n```\n\n### Ajoutez votre npm token\n\nPour faire fonctionner les actions on doit enregistrer un secret NPM_TOKEN.\n\nIl faut générer un access token sur npm :\n\n![Npm access token](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9icyha61tyima21mtzf5.png)\n \nCopiez le token dans les secrets Github :\n![Github action secret](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xy2xsmbx8v7e6ka5plex.png)\n\nMaintenant tout fonctionne, votre publication se fera toute seule.\n\n![Trigger github action](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oe3ocya9kr94ft0ukbmv.png)\n ","user":{"name":"Simon Boisset","username":"simonboisset","twitter_username":"simonboisset","github_username":"simonboisset","user_id":915286,"website_url":"https://simonboisset.com/","profile_image":"https://res.cloudinary.com/practicaldev/image/fetch/s--DlKPeeaN--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/915286/a3eb8e27-4168-4b37-9aa1-4a9561d1bd54.jpg","profile_image_90":"https://res.cloudinary.com/practicaldev/image/fetch/s--4RJ0oOij--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/915286/a3eb8e27-4168-4b37-9aa1-4a9561d1bd54.jpg"}}